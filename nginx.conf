# سطح http — تنظیمات کلی (gzip، cache، open_file_cache و بهینه‌سازی I/O)
http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    # open file cache (برای کاهش syscallها)
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # gzip (حداکثر فشرده‌سازی)
    gzip on;
    gzip_static on;                    # اگر فایل‌های .gz از قبل تولید شده‌اند از آن‌ها استفاده کن
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 9;                 # حداکثر سطح فشرده‌سازی gzip
    gzip_min_length 256;
    gzip_buffers 16 8k;
    gzip_disable "msie6";
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        image/svg+xml
        application/font-woff
        application/font-woff2
        application/vnd.ms-fontobject
        font/ttf
        font/otf;

    # Security-related headers (اختیاری و مفید)
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";

    # Server block پیش‌فرض — بدون server_name
    server {
        listen 80 default_server;
        # not setting server_name as requested

        root /usr/share/nginx/html;
        index index.html;

        # Serve directory listing by default
        autoindex on;
        autoindex_exact_size off;   # اندازه‌ها را به صورت خواناتر نمایش می‌دهد
        autoindex_localtime on;

        # SPA routing: fallback to index.html
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Static assets: aggressive browser caching + immutable
        location ~* \.(?:css|js|png|jpg|jpeg|gif|ico|svg|ttf|woff|woff2|eot)$ {
            # اجازه کش یک ساله در مرورگر
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable" always;

            # اگر فایل فیزیکی نیست خطای 404 بده (SPA روتینگ در / رسیدگی می‌شود)
            try_files $uri $uri/ =404;
        }

        # Compression: اگر gzip_static فعال است، nginx فایل .gz را مستقیم سرو می‌کند
        # برای فایل‌هایی که precompress ندارید، gzip runtime کار خواهد کرد (در سطح http)

        # Optional: reduce logging noise for static files
        location ~* \.(?:css|js|png|jpg|jpeg|gif|ico|svg|ttf|woff|woff2)$ {
            access_log off;
        }

        # Error pages (می‌توانید سفارشی کنید)
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }
    } # end server
} # end http
